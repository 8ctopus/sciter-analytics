<html
    window-width="800dip"
    window-height="800dip"
>
<head>
<style>

@import url(vendor/8ctopus/sciter-logger/src/logger.css);
@import url(vendor/8ctopus/sciter-pagecontrol/src/pagecontrol.css);
@import url(css/themes/default.css);

div.vbox {
    width: 200dip;
}

</style>
<script type="module">

import {logger} from "vendor/8ctopus/sciter-logger/src/logger.js";
import * as utils from "vendor/8ctopus/sciter-utils/src/utils.js";
import {dialogs} from "vendor/8ctopus/sciter-dialogs/src/dialogs.js";
import {uuid} from "@sciter";
import {analytics} from "src/analytics.js";

// initialize logger
logger.init({
    file: URL.toPath(__DIR__ + "test.log"),
    clear: true,
});

// attach logger to console
logger.attach();

// capture unhandled exceptions
logger.capture();

document.on("ready", function() {
    // subscribe to logger messages
    logger.plaintext(document.$("plaintext#logger"));

    // log sciter version
    console.debug(utils.sciterInfo());

    // initialize
    analytics.init({
        log: true,
        endpoint: "http://localhost/index.php",
        //endpoint: "https://httpbin.org/post",
    });

    // add more environmental variables
    analytics.env({
        name: "analytics",
        version: "0.0.1",
        uuid: uuid(),
    });

    analytics.event("app started");

    analytics.watch("focus", "plaintext", "plaintext focused");
    analytics.watch("focus", null, "focus");

    // watch app close
    analytics.watch("closerequest", null, "app close request");

    // center window on screen
    utils.centerWindow("screen");

    // add support for F5 reload
    utils.addReloadWindow();

    // close window on escape key press
    utils.closeWindowOnEscape();

    // bring window to front
    utils.windowToFront();

    // focus window
    utils.focusWindow();
});

document.on("closerequest", function(event) {
    if (dialogs.show("question", "Are you sure you want to quit?", "yes no cancel") !== "yes") {
        // cancel close
        event.preventDefault();
        return;
    }

    analytics.event("app closed");
});

const headers = {
    "Content-Type": "application/json; charset=utf-8",
    "Accept": "*/*",
};

document.on("click", "button#httpbin", function(event, button) {
    const url = "https://httpbin.org/post";

    const body = JSON.stringify({
        uuid: uuid(),
        event: "button clicked",
    });

    myfetch(url, headers, body);
});

// amplitude test
document.on("click", "button#amplitude", function() {
    const url = "https://api2.amplitude.com/2/httpapi";

    const body = JSON.stringify({
      "api_key": "my_amplitude_api_key",
      "events": [{
          "user_id": "datamonster@gmail.com",
          "device_id": "C8F9E604-F01A-4BD9-95C6-8E5357DF265D",
          "event_type": "watch_tutorial",
          "time": 1396381378123,
          "event_properties": {
            "load_time": 0.8371,
            "source": "notification",
            "dates": [
              "monday",
              "tuesday"
            ]
          },
          "app_version": "2.1.3",
          "platform": "iOS",
          "os_name": "Android",
          "os_version": "4.2.2",
          "device_brand": "Verizon",
          "device_manufacturer": "Apple",
          "device_model": "iPhone 9,1",
          "carrier": "Verizon",
          "country": "United States",
          "region": "California",
          "city": "San Francisco",
          "dma": "San Francisco-Oakland-San Jose, CA",
          "language": "English",
          "ip": "127.0.0.1",
        }
      ]
    });

    myfetch(url, headers, body);
});

document.on("click", "button#mixpanel", function() {
    const url = "https://api.mixpanel.com/track";

    const body = JSON.stringify({
        "event": "Signed up",
        "properties": {
            "distinct_id": "13793",
            "token": "YOUR_PROJECT_TOKEN",
        }
    });

    myfetch(url, headers, body);
});

document.on("click", function(event, element) {
    const pagecontrol = document.$("pagecontrol");

    switch (element.id) {
        case "btLogin":
            pagecontrol.showTab("tsDashboard");
            break;

        case "createAccount":
            pagecontrol.showTab("tsSignup");
            break;

        case "btSignUp":
            pagecontrol.showTab("tsLogin");
            break;

        case "forgotPassword":
            pagecontrol.showTab("tsReset");
            break;

        case "reset":
            pagecontrol.showTab("tsSent");
            break;

        case "showEvents":
            analytics.log();
            break;

        case "sendEvents":
            analytics.send();
            break;

        default:
    }
});

// handle show tab event
document.on("showtab", "pagecontrol", function(event, element) {
    console.debug(event.detail.tab);

    switch (event.detail.tab) {
        case "tsLogin":
            event = "start login";
            break;

        case "tsSignup":
            event = "start signup";
            break;

        case "tsDashboard":
            event = "end login";
            break;

        case "tsReset":
            event = "start reset";
            break;

        case "tsSent":
            event = "end reset";
            break;

        default:
    }

    //console.debug(`event - ${event}`);

    // log event
    analytics.event(event);
});

async function myfetch(url, headers, body)
{
    const response = await fetch(url, {
        method: "POST",
        cache: "no-cache",
        headers: headers,
        body: body,
    });

    console.line();
    console.log(`response status - ${response.status}`);

    const json = await response.json();

    //console.log(response.text());
    console.log(json);
}

</script>
</head>
<body>
    <button #httpbin>httpbin</button>
    <button #amplitude>amplitude</button>
    <button #mixpanel>mixpanel</button>
    <button #showEvents>show events</button>
    <button #sendEvents>send events</button>
    <pagecontrol header-position="top" header-visible="true">
        <tab caption="login" #tsLogin selected>
            <div .vbox>
                <h1> Sign-in </h1>
                <label for="email"> Username or email address </label>
                <input type="text" #email />
                <div .hbox>
                    <label for="password"> Password </label><a #forgotPassword .right tabindex> Forgot password? </a>
                </div>
                <input type="password" #password />
                <button #btLogin> Login </button>
                <p>New? <a #createAccount tabindex>Create an account</a>.</p>
            </div>
        </tab>
        <tab caption="signup" #tsSignup>
            <div .vbox>
                <h1> Sign Up </h1>
                <label for="email2"> Email address </label>
                <input type="text" #email2 />
                <label for="password2"> Password </label>
                <input type="password" #password2 />
                <button #btSignUp> Sign up </button>
            </div>
        </tab>
        <tab caption="dashboard" #tsDashboard>
            <div .vbox>
                <h1> Your Dashboard </h1>
            </div>
        </tab>
        <tab caption="reset" #tsReset>
            <div .vbox>
                <h1> Reset your password </h1>
                <label for="email2"> Enter your user account's verified email address and we will send you a password reset link. </label>
                <input type="text" #email2 />
                <button #reset> Send password reset email </button>
            </div>
        </tab>
        <tab caption="sent" #tsSent>
            <div .vbox>
                <h1> Password reset email sent! </h1>
            </div>
        </tab>
    </pagecontrol>
    <plaintext #logger readonly />
</body>
</html>
